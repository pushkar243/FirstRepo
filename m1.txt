02/07

import math
import pandas as pd

# Define batch size
batch_size = 1000
total_rows = len(df)

# Loop over DataFrame in batches
for i in range(0, total_rows, batch_size):
    # Get the current batch
    batch = df.iloc[i:i + batch_size].copy()
    
    # Clean and prepare the input text (if needed)
    batch["narrative_raw_plain"] = batch["narrative_raw"].apply(remove_html_tags)
    texts = batch["narrative_raw_plain"].fillna("").tolist()  # Avoid NaNs
    
    # Compute embeddings in batch using embed_documents
    batch["embedding_list"] = embeddings.embed_documents(texts)

# Safely assign back
    batch["embedding"] = embeddings_list

    # Optional print for tracking
    print(f"Embedding completed for batch {i // batch_size + 1}")

    # Write to database or wherever needed
    helper.write_to_db(batch, db_settings)



23/06
SELECT
    array_to_string(fa_names, '') AS fa_names,
    insight_type,
    array_to_string(
        ARRAY(
            SELECT fa || ' -> ' || insight_type
            FROM unnest(fa_names) AS fa
        ),
        ', '
    ) AS fa_insight_mapping
FROM
    sandbox_wma_shared.si_nlg_fa_narratives_review_curr2;


SELECT
    fa AS fa_name,
    insight_type
FROM
    sandbox_wma_shared.si_nlg_fa_narratives_review_curr2,
    UNNEST(fa_names) AS fa;


SELECT
    fa AS fa_name,
    ARRAY_AGG(DISTINCT insight_type) AS insight_types
FROM
    sandbox_wma_shared.si_nlg_fa_narratives_review_curr2,
    UNNEST(fa_names) AS fa
GROUP BY
    fa;


SELECT
    insight_type,
    ARRAY_AGG(DISTINCT fa) AS fa_names
FROM
    sandbox_wma_shared.si_nlg_fa_narratives_review_curr2,
    UNNEST(fa_names) AS fa
GROUP BY
    insight_type;

----------------------------------------------------------------------

WITH unnested_fa_names AS (
    SELECT unnest(fa_names) AS fa_name
    FROM sandbox_wma_shared.si_nlg_fa_narratives_review_curr2
),
fa_name_counts AS (
    SELECT fa_name, COUNT(*) AS cnt
    FROM unnested_fa_names
    GROUP BY fa_name
)
SELECT 
    fa_name,
    cnt AS occurrence_count
FROM fa_name_counts
WHERE cnt < 5
ORDER BY cnt ASC, fa_name;
